#! /bin/bash

wget -q -O - https://pkg.jenkins.io/debian/jenkins-ci.org.key | apt-key add -
sh -c 'echo deb http://pkg.jenkins.io/debian-stable binary/ > /etc/apt/sources.list.d/jenkins.list'
export DEBIAN_FRONTEND=noninteractive
apt-get update
apt-get -y install openjdk-8-jre ec2-instance-connect nfs-common unzip jq pacemaker corosync awscli crmsh pcs
apt-get -y install jenkins
mkdir -p /mnt/jenkins
echo "${efs_fqdn}:/ /mnt/jenkins nfs nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport 0 0" >> /etc/fstab
mount -a
[ "$(ls -A /mnt/jenkins/)" ] && cp -rf /var/lib/jenkins/* /mnt/jenkins/
chown -R jenkins. /mnt/jenkins
sed -i 's|^JENKINS_HOME=.*|JENKINS_HOME=/mnt/jenkins|g' /etc/default/jenkins
sed -i 's|^JENKINS_ARGS="|JENKINS_ARGS="--argumentsRealm.passwd.${user}=${password} --argumentsRealm.roles.${user}=admin |g' /etc/default/jenkins
service jenkins restart
export AWS_DEFAULT_REGION=$(curl -s 169.254.169.254/latest/meta-data/placement/availability-zone | sed 's/.$//')
echo "AWS_DEFAULT_REGION=$${AWS_DEFAULT_REGION}" >> /etc/default/pacemaker
cat <<-EOF | base64 -d > /usr/lib/ocf/resource.d/heartbeat/jenkins
IyEvYmluL3NoCgo6ICR7T0NGX0ZVTkNUSU9OU19ESVI9JHtPQ0ZfUk9PVH0vbGliL2hlYXJ0YmVhdH0KLiAke09DRl9GVU5DVElPTlNfRElSfS9vY2Ytc2hlbGxmdW5jcwoKbWV0YV9kYXRhKCkgewogIGNhdCA8PEVORAo8P3htbCB2ZXJzaW9uPSIxLjAiPz4KPCFET0NUWVBFIHJlc291cmNlLWFnZW50IFNZU1RFTSAicmEtYXBpLTEuZHRkIj4KPHJlc291cmNlLWFnZW50IG5hbWU9IkplbmtpbnMiPgo8dmVyc2lvbj4xLjA8L3ZlcnNpb24+Cgo8bG9uZ2Rlc2MgbGFuZz0iZW4iPgpUaGlzIGlzIGEgSmVua2lucyBSZXNvdXJjZSBBZ2VudC4gSXQgZG9lcyBhYnNvbHV0ZWx5IG5vdGhpbmcgZXhjZXB0CmtlZXAgdHJhY2sgb2Ygd2hldGhlciBpdHMgcnVubmluZyBvciBub3QuCkl0cyBwdXJwb3NlIGluIGxpZmUgaXMgZm9yIHRlc3RpbmcgYW5kIHRvIHNlcnZlIGFzIGEgdGVtcGxhdGUgZm9yIFJBIHdyaXRlcnMuCgpOQjogUGxlYXNlIHBheSBhdHRlbnRpb24gdG8gdGhlIHRpbWVvdXRzIHNwZWNpZmllZCBpbiB0aGUgYWN0aW9ucwpzZWN0aW9uIGJlbG93LiBUaGV5IHNob3VsZCBiZSBtZWFuaW5nZnVsIGZvciB0aGUga2luZCBvZiByZXNvdXJjZQp0aGUgYWdlbnQgbWFuYWdlcy4gVGhleSBzaG91bGQgYmUgdGhlIG1pbmltdW0gYWR2aXNlZCB0aW1lb3V0cywKYnV0IHRoZXkgc2hvdWxkbid0L2Nhbm5vdCBjb3ZlciBfYWxsXyBwb3NzaWJsZSByZXNvdXJjZQppbnN0YW5jZXMuIFNvLCB0cnkgdG8gYmUgbmVpdGhlciBvdmVybHkgZ2VuZXJvdXMgbm9yIHRvbyBzdGluZ3ksCmJ1dCBtb2RlcmF0ZS4gVGhlIG1pbmltdW0gdGltZW91dHMgc2hvdWxkIG5ldmVyIGJlIGJlbG93IDEwIHNlY29uZHMuCjwvbG9uZ2Rlc2M+CjxzaG9ydGRlc2MgbGFuZz0iZW4iPkV4YW1wbGUgc3RhdGVsZXNzIHJlc291cmNlIGFnZW50PC9zaG9ydGRlc2M+Cgo8cGFyYW1ldGVycz4KPHBhcmFtZXRlciBuYW1lPSJzdGF0ZSIgdW5pcXVlPSIxIj4KPGxvbmdkZXNjIGxhbmc9ImVuIj4KTG9jYXRpb24gdG8gc3RvcmUgdGhlIHJlc291cmNlIHN0YXRlIGluLgo8L2xvbmdkZXNjPgo8c2hvcnRkZXNjIGxhbmc9ImVuIj5TdGF0ZSBmaWxlPC9zaG9ydGRlc2M+Cjxjb250ZW50IHR5cGU9InN0cmluZyIgZGVmYXVsdD0iJHtIQV9SU0NUTVB9L0plbmtpbnMtJHtPQ0ZfUkVTT1VSQ0VfSU5TVEFOQ0V9LnN0YXRlIiAvPgo8L3BhcmFtZXRlcj4KCjwvcGFyYW1ldGVycz4KCjxhY3Rpb25zPgo8YWN0aW9uIG5hbWU9InN0YXJ0IiAgICAgICAgdGltZW91dD0iMjAiIC8+CjxhY3Rpb24gbmFtZT0ic3RvcCIgICAgICAgICB0aW1lb3V0PSIyMCIgLz4KPGFjdGlvbiBuYW1lPSJtb25pdG9yIiAgICAgIHRpbWVvdXQ9IjIwIiBpbnRlcnZhbD0iMTAiIGRlcHRoPSIwIiAvPgo8YWN0aW9uIG5hbWU9InJlbG9hZCIgICAgICAgdGltZW91dD0iMjAiIC8+CjxhY3Rpb24gbmFtZT0ibWlncmF0ZV90byIgICB0aW1lb3V0PSIyMCIgLz4KPGFjdGlvbiBuYW1lPSJtaWdyYXRlX2Zyb20iIHRpbWVvdXQ9IjIwIiAvPgo8YWN0aW9uIG5hbWU9Im1ldGEtZGF0YSIgICAgdGltZW91dD0iNSIgLz4KPGFjdGlvbiBuYW1lPSJ2YWxpZGF0ZS1hbGwiICAgdGltZW91dD0iMjAiIC8+CjwvYWN0aW9ucz4KPC9yZXNvdXJjZS1hZ2VudD4KRU5ECn0KCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCgpqZW5raW5zX3VzYWdlKCkgewogIGNhdCA8PEVORAp1c2FnZTogJDAge3N0YXJ0fHN0b3B8bW9uaXRvcnxtaWdyYXRlX3RvfG1pZ3JhdGVfZnJvbXx2YWxpZGF0ZS1hbGx8bWV0YS1kYXRhfQoKRXhwZWN0cyB0byBoYXZlIGEgZnVsbHkgcG9wdWxhdGVkIE9DRiBSQS1jb21wbGlhbnQgZW52aXJvbm1lbnQgc2V0LgpFTkQKfQoKamVua2luc19zdGFydCgpIHsKICAgIGplbmtpbnNfbW9uaXRvcgogICAgc3lzdGVtY3RsIHJlc3RhcnQgamVua2lucwogICAgaWYgWyAkPyA9ICAkT0NGX1NVQ0NFU1MgXTsgdGhlbgogIHJldHVybiAkT0NGX1NVQ0NFU1MKICAgIGZpCiAgICB0b3VjaCAke09DRl9SRVNLRVlfc3RhdGV9Cn0KCmplbmtpbnNfc3RvcCgpIHsKICAgIGplbmtpbnNfbW9uaXRvcgogICAgaWYgWyAkPyA9ICAkT0NGX1NVQ0NFU1MgXTsgdGhlbgogIHJtICR7T0NGX1JFU0tFWV9zdGF0ZX0KICAgIGZpCiAgICByZXR1cm4gJE9DRl9TVUNDRVNTCn0KCmplbmtpbnNfbW9uaXRvcigpIHsKICBpZiBbIC1mICR7T0NGX1JFU0tFWV9zdGF0ZX0gXTsgdGhlbgogICAgICByZXR1cm4gJE9DRl9TVUNDRVNTCiAgZmkKICBpZiBmYWxzZSA7IHRoZW4KICAgIHJldHVybiAkT0NGX0VSUl9HRU5FUklDCiAgZmkKCiAgaWYgISBvY2ZfaXNfcHJvYmUgJiYgWyAiJF9fT0NGX0FDVElPTiIgPSAibW9uaXRvciIgXTsgdGhlbgogICAgb2NmX2V4aXRfcmVhc29uICJObyBwcm9jZXNzIHN0YXRlIGZpbGUgZm91bmQiCiAgZmkKICByZXR1cm4gJE9DRl9OT1RfUlVOTklORwp9CgpqZW5raW5zX3ZhbGlkYXRlKCkgewogICAgc3RhdGVfZGlyPWBkaXJuYW1lICIkT0NGX1JFU0tFWV9zdGF0ZSJgCiAgICB0b3VjaCAiJHN0YXRlX2Rpci8kJCIKICAgIGlmIFsgJD8gIT0gMCBdOyB0aGVuCiAgb2NmX2V4aXRfcmVhc29uICJTdGF0ZSBmaWxlIFwiJE9DRl9SRVNLRVlfc3RhdGVcIiBpcyBub3Qgd3JpdGFibGUiCiAgcmV0dXJuICRPQ0ZfRVJSX0FSR1MKICAgIGZpCiAgICBybSAiJHN0YXRlX2Rpci8kJCIKCiAgICByZXR1cm4gJE9DRl9TVUNDRVNTCn0KCjogJHtPQ0ZfUkVTS0VZX3N0YXRlPSR7SEFfUlNDVE1QfS9KZW5raW5zLSR7T0NGX1JFU09VUkNFX0lOU1RBTkNFfS5zdGF0ZX0KCgpjYXNlICRfX09DRl9BQ1RJT04gaW4KbWV0YS1kYXRhKSAgbWV0YV9kYXRhCiAgICBleGl0ICRPQ0ZfU1VDQ0VTUwogICAgOzsKc3RhcnQpICAgIGplbmtpbnNfc3RhcnQ7OwpzdG9wKSAgIGplbmtpbnNfc3RvcDs7Cm1vbml0b3IpICBqZW5raW5zX21vbml0b3I7OwptaWdyYXRlX3RvKSBvY2ZfbG9nIGluZm8gIk1pZ3JhdGluZyAke09DRl9SRVNPVVJDRV9JTlNUQU5DRX0gdG8gJHtPQ0ZfUkVTS0VZX0NSTV9tZXRhX21pZ3JhdGVfdGFyZ2V0fS4iCiAgICAgICAgICBqZW5raW5zX3N0b3AKICAgIDs7Cm1pZ3JhdGVfZnJvbSkgb2NmX2xvZyBpbmZvICJNaWdyYXRpbmcgJHtPQ0ZfUkVTT1VSQ0VfSU5TVEFOQ0V9IGZyb20gJHtPQ0ZfUkVTS0VZX0NSTV9tZXRhX21pZ3JhdGVfc291cmNlfS4iCiAgICAgICAgICBqZW5raW5zX3N0YXJ0CiAgICA7OwpyZWxvYWQpICAgb2NmX2xvZyBpbmZvICJSZWxvYWRpbmcgJHtPQ0ZfUkVTT1VSQ0VfSU5TVEFOQ0V9IC4uLiIKICAgIDs7CnZhbGlkYXRlLWFsbCkgamVua2luc192YWxpZGF0ZTs7CnVzYWdlfGhlbHApIGplbmtpbnNfdXNhZ2UKICAgIGV4aXQgJE9DRl9TVUNDRVNTCiAgICA7OwoqKSAgICBqZW5raW5zX3VzYWdlCiAgICBleGl0ICRPQ0ZfRVJSX1VOSU1QTEVNRU5URUQKICAgIDs7CmVzYWMKcmM9JD8Kb2NmX2xvZyBkZWJ1ZyAiJHtPQ0ZfUkVTT1VSQ0VfSU5TVEFOQ0V9ICRfX09DRl9BQ1RJT04gOiAkcmMiCmV4aXQgJHJjCg==
EOF
chmod 755 /usr/lib/ocf/resource.d/heartbeat/jenkins
cat <<-EOF > /etc/corosync/corosync.conf
totem {
    version: 2
    secauth: off
    rrp_mode:active
    cluster_name: jenkins
    transport: udpu
    token: 17000
}

nodelist {
    node {
        ring0_addr: ip-192-168-168-106
        nodeid: 1
    }
    node {
        ring0_addr: ip-192-168-168-138
        nodeid: 2
    }
    node {
        ring0_addr: ip-192-168-168-170
        nodeid: 3
    }
}

quorum {
    provider: corosync_votequorum
    expected_votes: 3
}
EOF
crm configure property stonith-enabled=false
systemctl restart corosync pacemaker
crm configure primitive elastic-ip ocf:heartbeat:awseip params elastic_ip="${eip}" awscli="$(which aws)" allocation_id="${eip_allocation}" op start   timeout="60s" interval="0s"  on-fail="restart"     op monitor timeout="60s" interval="10s" on-fail="restart"     op stop    timeout="60s" interval="0s"  on-fail="block" meta migration-threshold="2" failure-timeout="60s" resource-stickiness="100"
crm configure primitive jenkins ocf:heartbeat:jenkins
crm configure group jenkins-master elastic-ip jenkins
